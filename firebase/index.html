<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Items</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="style.css">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script>
</head>

<body>
	<div class="divCentral">
		<div class="divInicios">

			<!-- DIV mostrar opciones -->
			<div class="eleccionMetodo">

				<div class="perfil">
					<img src="imatges/ico.png" alt="" srcset="">
				</div>

				<div class="metodo">
					<h1>
						Coneix el que pasa al món
					</h1>
					<h2>
						Uneix-te i comparteix les teves experiències
					</h2>

					<div class="botonesDiv">
						
						<button type="button" class="boton" id="login">Entrar</button>
						<button type="button" class="boton" id="newUser">Registrar un nou usuari</button>
					</div>
				</div>

			</div>


			<!-- Div de login inicial -->
			
			<div id="loginForm">
				
				<form class="FormInicio">
					<div>
						<h2>
							Iniciar sessió
						</h2>
						<label for="title"><h2>Correu electrònic:</h2></label>
						
						<input type="email" id="loginEmail">
						
					</div>
					<div >
						<label for="content" ><h2>Contrasenya:</h2> </label>
						
						<input type="password"  id="loginPassword">
						
					</div>
					<div >
						<button type="button" id="login">Entrar</button>
						<button type="button" id="newUser2">Registrar un nou usuari</button>
					</div>
				</form>
			</div>


			<!-- Div de crear usuari -->
			<div id="signupForm" style="display: none;">
				<form class="FormInicio">
					<div >
						<h2>
							Crear un compte
						</h2>
						<label for="title" class="col-4 col-form-label"><h2>Correu electrònic:</h2></label>
						<input type="email" class="form-control" id="signupEmail">
					</div>
					<div>
						<label for="content" > <h2>Contrasenya:</h2></label>
						
						<input type="password" id="signupPassword">
					</div>
					<div >
						<label for="content" > <h2>Confirmar contrasenya:</h2></label>
						
						<input type="password"id="signupPasswordConfirm">
					</div>
					<div >
						
						<button type="button" id="signup">Enviar</button>
						
					</div>
				</form>
			</div>



			<!-- Div de subir y mostrar contenido -->
			<div id="itemsForm" style="display: none;">
				<form>
					<div>
						<label for="title">Títol:</label>
						<div class="col-8">
							<input type="text" id="title">
						</div>
					</div>
					<div >
						<label for="content" >Contingut:</label>
						<div class="col-8">
							<input type="text" id="content">
						</div>
					</div>
					<div >
						<label for="image">Imatge:</label>
						<div >
							<input type="file" id="image">
						</div>
						<div >
							<img id="thumbnail"
								style="max-width: 60px; max-height: 60px; visibility: hidden;" alt="imatge">
						</div>
					</div>
					<div >
						<div >
							<button type="button" id="save" >Guardar</button>
						</div>
					</div>
					<input type="hidden" id="elementId">
				</form>
			</div>

			<div >
				<div id="alert" role="alert"></div>
			</div>
		</div>
		<div >
			<table id="listItems" style="display: none;">
			</table>
		</div>
	</div>
</body>
<script language="javascript" src="js/config.js"></script>
<script language="javascript" src="js/firestore.js"></script>
<script language="javascript" src="js/storage.js"></script>
<script language="javascript" src="js/items.js"></script>
<script language="javascript">

	let imatgeModificada = false;

	function eliminar(itemId, imageUrl) {
		deleteFile(imageUrl)
			.then(() => {
				deleteItem(itemId);
			}).catch(() => {
				showAlert("Error al intentar eliminar la imatge", "alert-danger");
			});
	}

	function showAlert(text, type) {
		document.getElementById("alert").innerText = text;
		document.getElementById("alert").className = "alert " + type;
		document.getElementById("alert").style.display = "block";
		window.setTimeout(function () {
			document.getElementById("alert").style.display = "none";
		}, 2000);
	}

	window.addEventListener("load", function () {
		loadItems();
	});

	document.getElementById("login").addEventListener("click", function () {
		let email = document.getElementById("loginEmail").value;
		let password = document.getElementById("loginPassword").value;

		auth.signInWithEmailAndPassword(email, password)
			.then(function () {
				showAlert("Usuari autenticat", "alert-success");

				document.getElementById("loginForm").style.display = "none";
				document.getElementById("itemsForm").style.display = "block";
				document.getElementById("listItems").style.display = "table";
			})
			.catch(function (error) {
				showAlert("Error d’autenticació", "alert-danger");
			});
	});

	document.getElementById("newUser").addEventListener("click", function () {
		document.getElementById("loginForm").style.display = "none";
		document.getElementById("signupForm").style.display = "block";
	});

	document.getElementById("signup").addEventListener("click", function () {
		let email = document.getElementById("signupEmail").value;
		let password = document.getElementById("signupPassword").value;
		let passwordConfirm = document.getElementById("signupPasswordConfirm").value;

		if (email.length > 0 && email.indexOf("@") > 1) {
			if (password.length > 0) {
				if (password == passwordConfirm) {
					auth.createUserWithEmailAndPassword(email, password)
						.then(function () {
							showAlert("Usuari creat correctament", "alert-success");

							document.getElementById("loginForm").style.display = "block";
							document.getElementById("signupForm").style.display = "none";
						})
						.catch(function (error) {
							showAlert("Error al intentar crear l'usuari", "alert-danger");
						});
				} else {
					showAlert("Les contrasenyes no coincideixen", "alert-danger");
				}
			} else {
				showAlert("La contrasenya és obligatòria", "alert-danger");
			}
		} else {
			showAlert("Email incorrecte", "alert-danger");
		}
	});

	document.getElementById("save").addEventListener("click", function () {
		let id = document.getElementById("elementId").value;
		let title = document.getElementById("title").value;
		let content = document.getElementById("content").value;
		let image = document.getElementById("image").files[0];
		let doc = {
			content: content,
			title: title
		};

		if (id == "") {
			uploadFile(image)
				.then((imageUrl) => {
					doc.image = imageUrl;
					addItem(doc);
				})
				.catch(() => {
					showAlert("Error al intentar guardar l'element", "alert-danger");
				});
		} else {
			if (imatgeModificada) {
				let currentImageUrl = document.getElementById("thumbnail").src;
				deleteFile(currentImageUrl)
					.then(() => {
						uploadFile(image)
							.then((imageUrl) => {
								doc.image = imageUrl;
								updateItem(id, doc);
							})
							.catch(() => {
								showAlert("Error al intentar actualitzat l'element", "alert-danger");
							});
					})
					.catch(() => {
						showAlert("Error al intentar actualitzat l'element", "alert-danger");
					});
			} else {
				updateItem(id, doc);
			}
		}

		imatgeModificada = false;
	});

	document.getElementById("image").addEventListener("change", function () {
		imatgeModificada = true;
	});

</script>

</html>